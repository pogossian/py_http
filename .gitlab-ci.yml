variables:
    LATEST_VER: pogossian/pyhttp:latest
    MAJOR_VER: pogossian/pyhttp:1
    MINOR_VER: pogossian/pyhttp:1.0
    BUGFIX_VER: pogossian/pyhttp:1.0.2
    MOUNT_DIRECTORY: /mnt/cephfs/
    CEPH_MONITORS: 10.120.29.114:6789,10.120.28.174:6789,10.120.29.159:6789
    PV_PATH: pvc-volumes/kubernetes/kubernetes-dynamic-pvc-3e7cfd79-29c6-11ea-a936-9e006f2f84c4
  
stages:
- Build image
# - Push to Docker Hub
- Deploy

build image:
    stage: Build image
    script:
    - docker build -t $LATEST_VER -t $MAJOR_VER -t $MINOR_VER -t $BUGFIX_VER .
  

# push image:
#     stage: Push to Docker Hub
#     only:
#     - master
#     script:
#     - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin
#     - docker push $LATEST_VER && docker image rm $LATEST_VER
#     - docker push $MAJOR_VER && docker image rm $MAJOR_VER
#     - docker push $MINOR_VER && docker image rm $MINOR_VER
#     - docker push $BUGFIX_VER && docker image rm $BUGFIX_VER
    
      

deploy on k8s:
    stage: Deploy
    # before_script:
    # - sudo mkdir -p ${MOUNT_DIRECTORY}
    # - sudo mount -t ceph ${CEPH_MONITORS}:/ ${MOUNT_DIRECTORY} -o name=${CEPH_USER},secret=${CEPH_SECRET}
    # - sudo cp -r static/* ${MOUNT_DIRECTORY}${PV_PATH}/
    # - sudo umount ${MOUNT_DIRECTORY}
    script:
    - ansible-playbook playbook.yml